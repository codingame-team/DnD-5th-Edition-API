{% extends "base.html" %}

{% block title %}Fiche de {{ character.name }} - D&D 5e Demo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <!-- En-tête -->
        <div class="card shadow-lg mb-3">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0"><i class="bi bi-person-badge"></i> {{ character.name }}</h2>
                    <a href="/party" class="btn btn-sm btn-light">
                        <i class="bi bi-arrow-left"></i> Retour au Groupe
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong><i class="bi bi-person"></i> Race:</strong> {{ character.race|title }}</p>
                        <p><strong><i class="bi bi-shield"></i> Classe:</strong> {{ character.class|title }}</p>
                        <p><strong><i class="bi bi-star"></i> Niveau:</strong> {{ character.level }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="bi bi-heart-fill text-danger"></i> Points de Vie:</strong> {{ character.hp }}/{{ character.max_hp }}</p>
                        <p><strong><i class="bi bi-shield-fill-check text-primary"></i> Classe d'Armure:</strong> {{ character.ac }}</p>
                        <p><strong><i class="bi bi-coin text-warning"></i> Or:</strong> {{ character.gold }} po</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Caractéristiques -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-stars"></i> Caractéristiques</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3 bg-dark">
                                    <div class="h2 mb-0 text-danger">{{ character.str }}</div>
                                    <small class="text-light fw-bold">FORCE</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3 bg-dark">
                                    <div class="h2 mb-0 text-success">{{ character.dex }}</div>
                                    <small class="text-light fw-bold">DEXTÉRITÉ</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3 bg-dark">
                                    <div class="h2 mb-0 text-info">{{ character.con }}</div>
                                    <small class="text-light fw-bold">CONSTITUTION</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3 bg-dark">
                                    <div class="h2 mb-0 text-primary">{{ character.int }}</div>
                                    <small class="text-light fw-bold">INTELLIGENCE</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3 bg-dark">
                                    <div class="h2 mb-0 text-warning">{{ character.wis }}</div>
                                    <small class="text-light fw-bold">SAGESSE</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3 bg-dark">
                                    <div class="h2 mb-0 text-light">{{ character.cha }}</div>
                                    <small class="text-light fw-bold">CHARISME</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Équipement -->
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bag"></i> Équipement et Inventaire</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-shield-check"></i> Équipé</h6>
                                <div class="list-group mb-3">
                                    <div class="list-group-item">
                                        <strong>Arme:</strong>
                                        {% if character.weapon %}
                                            <span class="badge bg-primary">{{ character.weapon }}</span>
                                        {% else %}
                                            <span class="text-muted">Mains nues</span>
                                        {% endif %}
                                    </div>
                                    <div class="list-group-item">
                                        <strong>Armure:</strong>
                                        {% if character.armor %}
                                            <span class="badge bg-info">{{ character.armor }}</span>
                                        {% else %}
                                            <span class="text-muted">Aucune</span>
                                        {% endif %}
                                    </div>
                                    <div class="list-group-item">
                                        <strong>Bouclier:</strong>
                                        {% if character.shield %}
                                            <span class="badge bg-success">{{ character.shield }}</span>
                                        {% else %}
                                            <span class="text-muted">Aucun</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-backpack"></i> Inventaire</h6>
                                {% if character.inventory and character.inventory|length > 0 %}
                                    <div class="list-group" style="max-height: 400px; overflow-y: auto;">
                                        {% for item in character.inventory %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <strong>{{ item.name }}</strong>
                                                    <br><small class="text-muted">Type: {{ item.type }}</small>
                                                </div>
                                                <div class="btn-group-vertical btn-group-sm">
                                                    {% if item.type in ['Weapon', 'Armor', 'Shield'] %}
                                                    <button class="btn btn-primary" onclick="equipItem({{ index }}, '{{ item.name }}', '{{ item.type }}')">
                                                        <i class="bi bi-box-arrow-in-right"></i> Équiper
                                                    </button>
                                                    {% endif %}
                                                    <button class="btn btn-danger" onclick="dropItem({{ index }}, '{{ item.name }}')">
                                                        <i class="bi bi-trash"></i> Jeter
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted"><i>Inventaire vide</i></p>
                                {% endif %}

                                <!-- Bouton pour déséquiper -->
                                <div class="mt-3">
                                    {% if character.weapon or character.armor or character.shield %}
                                    <button class="btn btn-warning btn-sm w-100" onclick="unequipAll({{ index }})">
                                        <i class="bi bi-box-arrow-left"></i> Tout Déséquiper
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a href="/shop" class="btn btn-success">
                                <i class="bi bi-shop"></i> Visiter le Magasin de Boltac
                            </a>
                            <a href="/character/{{ index }}/inventory" class="btn btn-info">
                                <i class="bi bi-backpack"></i> Inventaire Détaillé
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Expérience -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-star-fill"></i> Progression</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Expérience:</strong> {{ character.xp }} XP</p>
                        <div class="progress" style="height: 30px;">
                            {% set next_level_xp = {
                                1: 300, 2: 900, 3: 2700, 4: 6500, 5: 14000,
                                6: 23000, 7: 34000, 8: 48000, 9: 64000, 10: 85000
                            } %}
                            {% set required_xp = next_level_xp.get(character.level, 100000) %}
                            {% set xp_percent = (character.xp / required_xp * 100)|int %}
                            <div class="progress-bar bg-warning" style="width: {{ xp_percent }}%">
                                {{ character.xp }} / {{ required_xp }} XP
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            {% if xp_percent >= 100 %}
                                <i class="bi bi-arrow-up-circle-fill text-success"></i> Prêt à passer au niveau {{ character.level + 1 }} !
                            {% else %}
                                {{ required_xp - character.xp }} XP avant le prochain niveau
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const charIndex = {{ index }};

function equipItem(charIdx, itemName, itemType) {
    // Pas de confirmation - action directe
    fetch(`/api/character/${charIdx}/equip`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({item_name: itemName, item_type: itemType})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Rechargement forcé de la page
            window.location.href = window.location.href;
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => alert('Erreur: ' + error.message));
}

function unequipAll(charIdx) {
    // Pas de confirmation - action directe
    fetch(`/api/character/${charIdx}/unequip-all`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Rechargement forcé de la page
            window.location.href = window.location.href;
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => alert('Erreur: ' + error.message));
}

function dropItem(charIdx, itemName) {
    if (!confirm(`Jeter ${itemName} ? Cette action est irréversible.`)) return;

    fetch(`/api/character/${charIdx}/drop`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({item_name: itemName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Rechargement forcé de la page
            window.location.href = window.location.href;
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => alert('Erreur: ' + error.message));
}
</script>
{% endblock %}

